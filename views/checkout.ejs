<style>
  .align-middle {
    color: black;
    vertical-align: middle !important;
  }

  .card {
    margin-bottom: 2vh !important;
  }
  .card-text-small {
    font-size: 14px;
  }

  .card {
    margin-bottom: 10vh;
  }

  .card-text-bold {
    font-weight: bold;
  }

  .justify-content-end {
    margin-bottom: 2rem;
    margin-right: 2rem;
  }

  .form-control {
    display: block;
    width: 100%;
    height: calc(1.5em + 0.75rem + 2px);
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }

  /* The Modal */
  .modal {
    display: none; /* Hide the modal by default */
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(
      0,
      0,
      0,
      0.8
    ); /* Create a semi-transparent background overlay */
  }

  /* Modal Content */
  .modal-content {
    background-color: #fefefe;
    padding: 20px;
    width: 100%;
    position: relative;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
    border-radius: 1rem;
    margin: 0 auto;
  }

  /* Close Button */

  /* Blur the background */
  body.modal-open {
    overflow: hidden; /* Prevent scrolling on the background */
  }

  .modal-open .modal {
    overflow: auto;
  }

  .modal-open .modal-content {
    margin-top: 20vh;
  }
</style>
<section class="mt-5 container">
  <!-- Page Content Goes Here -->

  <h1 class="mb-4 display-5 fw-bold text-center">Checkout Securely</h1>

  <div class="row">
    <!-- Select Address -->
    <div class="col-lg-7">
      <!-- Add New Address card -->
      <div class="card mt-4">
        <div class="card-body">
          <h5 class="card-title">Add New Address</h5>
          <p class="card-text">Click here to add a new address.</p>
          <a id="addNewAddress" class="btn btn-primary">Add New Address</a>
        </div>
      </div>
      <!-- /Add New Address card -->
      <h5 class="card-title">Select Address</h5>
      <% addresses.forEach(address => { %>
      <!-- address card -->
      <div class="card address-card">
        <div class="card-body">
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="card-selection"
              id="radio-<%= address.id %>"
              data-address-id="<%= address.id %>"
              onchange="selectAddress('<%= address.id %>')"
            />
            <label class="form-check-label" for="card2">
              <h5 class="card-title">
                <%= address.fname %> <%= address.lname %>
              </h5>
            </label>
          </div>
          <p class="card-text card-text-small">
            <%= address.address %> , <%= address.state %> , <%= address.country
            %>
          </p>
          <p class="card-text card-text-small">Email :<%= address.email %></p>
          <p class="card-text card-text-small">
            Mobile: <%= address.phoneNumber %>
          </p>
          <p class="card-text card-text-small"><%= address.zipcode %></p>
          <br />
          <p class="card-text card-text-small">â€¢ Pay on Delivery available</p>
          <div style="margin-bottom: 0%" class="d-flex justify-content-end">
            <button
              class="btn btn-primary me-2 edit-btn edit-btn-<%= address.id %>"
              id="editAddressButton"
              style="display: none"
              onclick="openEditModal('<%= address.id %>')"
            >
              <a style="text-decoration: none; color: #fff">Edit</a>
            </button>

            <button
              class="btn btn-danger remove-btn remove-btn-<%= address.id %>"
              style="display: none"
            >
              Remove
            </button>
          </div>
        </div>
      </div>
      <!-- /address card -->
      <% }); %>

      <!-- Add address modaal -->
      <!-- The Modal -->
      <div id="myModal" class="modal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content" style="border-radius: 1rem">
            <div>
              <button
                type="button"
                class="btn-close"
                data-dismiss="modal"
                aria-label="Close"
              >
                &times;
              </button>
            </div>
            <div class="modal-body pt-0">
              <h5 class="title-checkout">Shipping Address</h5>
              <form method="post" action="/add-address" id="addressForm">
                <div class="form-group col-12">
                  <label for="email" class="form-label">Email</label>
                  <input
                    type="text"
                    class="form-control"
                    id="Email"
                    placeholder="you@example.com"
                    required=""
                  />
                </div>
                <div class="form-group col-12">
                  <label for="phoneNumber" class="form-label"
                    >Mobile Number</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="phoneNumber"
                    required=""
                  />
                </div>
                <div class="form-group d-flex">
                  <!-- First name -->
                  <div class="col-sm-6">
                    <div class="form-group">
                      <label for="firstName" class="form-label"
                        >First name</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="firstName"
                        placeholder=""
                        value=""
                        required=""
                      />
                    </div>
                  </div>
                  <!-- Last Name-->
                  <div class="col-sm-6">
                    <div class="form-group">
                      <label for="lastName" class="form-label">Last name</label>
                      <input
                        type="text"
                        class="form-control"
                        id="lastName"
                        placeholder=""
                        value=""
                        required=""
                      />
                    </div>
                  </div>
                </div>
                <div class="form-group col-12">
                  <label for="address" class="form-label">Address</label>
                  <input
                    type="text"
                    class="form-control"
                    id="address"
                    placeholder="123 Some Street Somewhere"
                    required=""
                  />
                </div>

                <div class="form-group col-12">
                  <label for="country" class="form-label">Country</label>
                  <select class="form-control" id="country" required="">
                    <option value="">Please Select...</option>
                    <option>India</option>
                    <option>United States</option>
                  </select>
                </div>
                <div class="d-flex">
                  <div class="form-group col-6">
                    <label for="address" class="form-label">State</label>
                    <select class="form-control" id="state" required="">
                      <option value="">Please Select...</option>
                      <option>Goa</option>
                      <option>Gujarat</option>
                      <option>Karnataka</option>
                      <option>Kerala</option>
                      <option>Tamil Nadu</option>
                    </select>
                  </div>

                  <div class="form-group col-6">
                    <label for="address" class="form-label"
                      >Zip / Post Code</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="zipCode"
                      required=""
                    />
                  </div>
                </div>
                <div class="form-group col-12">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    id="same-address"
                    checked
                  />
                  <label class="form-check-label" for="same-address"
                    >Use for billing address</label
                  >
                </div>
                <button type="submit" class="btn btn-success">Submit</button>
              </form>
            </div>
            <div class="modal-footer"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- / Select Address -->

    <!-- Edit Address Modal -->
    <div id="editModal" class="modal">
      <!-- Modal content -->
      <div class="modal-content">
        <!-- Modal header -->
        <div class="modal-header">
          <h5 class="modal-title">Edit Address</h5>
          <button
            type="button"
            class="btn-close-editModal"
            data-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <!--Edit Modal body -->
        <div class="modal-body">
          <form method="post" action="/submit-address" id="editAddressForm">
            <!-- Add hidden input field for address ID -->
            <input type="hidden" id="addressId" name="addressId" value="" />
            <div class="form-group col-12">
              <label for="email" class="form-label">Email</label>
              <input
                type="text"
                class="form-control"
                id="editEmail"
                value=""
                required=""
              />
            </div>
            <div class="form-group col-12">
              <label for="phoneNumber" class="form-label">Mobile Number</label>
              <input
                type="text"
                class="form-control"
                id="editPhoneNumber"
                required=""
              />
            </div>
            <div class="form-group d-flex">
              <!-- First name -->
              <div class="col-sm-6">
                <div class="form-group">
                  <label for="editFirstName" class="form-label"
                    >First name</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="editFirstName"
                    placeholder=""
                    value=""
                    required=""
                  />
                </div>
              </div>
              <!-- Last Name-->
              <div class="col-sm-6">
                <div class="form-group">
                  <label for="lastName" class="form-label">Last name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="editLastName"
                    placeholder=""
                    value=""
                    required=""
                  />
                </div>
              </div>
            </div>
            <div class="form-group col-12">
              <label for="address" class="form-label">Address</label>
              <input
                type="text"
                class="form-control"
                id="editAddress"
                placeholder="123 Some Street Somewhere"
                required=""
              />
            </div>

            <div class="form-group col-12">
              <label for="address" class="form-label">Country</label>
              <select class="form-control" id="editCountry" required="">
                <option value="">Please Select...</option>
                <option>India</option>
                <option>United States</option>
              </select>
            </div>
            <div class="d-flex">
              <div class="form-group col-6">
                <label for="state" class="form-label">State</label>
                <select class="form-control" id="editState" required="">
                  <option value="">Please Select...</option>
                  <option>Goa</option>
                  <option>Gujarat</option>
                  <option>Karnataka</option>
                  <option>Kerala</option>
                  <option>Tamil Nadu</option>
                </select>
              </div>

              <div class="form-group col-6">
                <label for="address" class="form-label">Zip / Post Code</label>
                <input
                  type="text"
                  class="form-control"
                  id="editZipCode"
                  required=""
                />
              </div>
            </div>
            <div class="form-group col-12">
              <input
                type="checkbox"
                class="form-check-input"
                value=""
                id="editSameAddress"
                checked
              />
              <label class="form-check-label" for="same-address"
                >Use for billing address</label
              >
            </div>
            <a
              type="submit"
              id="submitAddressButton"
              class="btn btn-success"
            >
              Save Changes
          </a>
          </form>
        </div>
        <div class="modal-footer"></div>
      </div>
    </div>

    <!-- Checkout Panel Summary -->
    <div class="col-lg-5">
      <div class="bg-light p-4 sticky-md-top top-5">
        <div class="border-bottom pb-3">
          <!-- Cart Item-->
          <% products.forEach((item) => { %>
          <div
            class="d-none d-md-flex justify-content-between align-items-start py-2"
          >
            <div
              class="d-flex flex-grow-1 justify-content-start align-items-start"
            >
              <div class="position-relative f-w-20 border p-2 me-4">
                <span class="checkout-item-qty">1</span>
                <img
                  src="/<%= item.image %>"
                  alt=""
                  class="rounded img-fluid"
                />
              </div>

              <div>
                <p class="mb-1 fs-6 fw-bolder"><%= item.name %></p>
                <small class="d-block text-muted">Mens / Blue / Medium</small>
                <span class="fs-xs text-uppercase fw-bolder text-muted"></span>
              </div>
            </div>
            <div class="flex-shrink-0 fw-bolder">
              <span>$<%= item.price %></span>
            </div>
          </div>

          <!-- / Cart Item-->
          <% }); %>
        </div>
        <div class="py-3 border-bottom">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <p class="m-0 fw-bolder fs-6">Subtotal</p>
            <p class="m-0 fs-6 fw-bolder">$<%= subtotal %></p>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <p class="m-0 fw-bolder fs-6">Shipping</p>
            <p class="m-0 fs-6 fw-bolder">$8.95</p>
          </div>
        </div>
        <div class="py-3 border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="m-0 fw-bold fs-5">Grand Total</p>
              <span class="text-muted small">Inc $45.89 sales tax</span>
            </div>
            <p class="m-0 fs-5 fw-bold">$<%= grandTotal %></p>
          </div>
        </div>
        <div class="py-3 border-bottom">
          <div class="input-group mb-0">
            <input
              type="text"
              class="form-control"
              placeholder="Enter your coupon code"
            />
            <button class="btn btn-dark btn-sm px-4">Apply</button>
          </div>
        </div>
        <!-- Accept Terms Checkbox-->
        <div class="form-group form-check my-4">
          <input
            type="checkbox"
            class="form-check-input"
            id="accept-terms"
            checked
          />
          <label class="form-check-label fw-bolder" for="accept-terms"
            >I agree to Alpine's <a href="#">terms & conditions</a></label
          >
        </div>
        <a href="#" class="btn btn-dark w-100" role="button">Complete Order</a>
      </div>
    </div>
    <!-- / Checkout Panel Summary -->
  </div>

  <!-- /Page Content -->
</section>

<script>
  function selectAddress(addressId) {
    // Hide all edit and remove buttons
    const editButtons = document.querySelectorAll(".edit-btn");
    const removeButtons = document.querySelectorAll(".remove-btn");
    editButtons.forEach((button) => {
      button.style.display = "none";
    });
    removeButtons.forEach((button) => {
      button.style.display = "none";
    });

    // Show edit and remove buttons for the selected address
    const editButton = document.querySelector(".edit-btn-" + addressId);
    const removeButton = document.querySelector(".remove-btn-" + addressId);
    editButton.style.display = "block";
    removeButton.style.display = "block";
  }
</script>

<script>
  // script for the Add Address

  var modal = document.getElementById("myModal");

  // Get the button that opens the modal
  var btn = document.getElementById("addNewAddress");

  // Get the close button
  var closeBtn = document.getElementsByClassName("btn-close")[0];

  // Open the modal when the button is clicked
  btn.addEventListener("click", function () {
    modal.style.display = "block";
  });

  // Close the modal when the close button is clicked
  closeBtn.addEventListener("click", function () {
    modal.style.display = "none";
  });

  // Close the modal when the user clicks outside of it
  window.addEventListener("click", function (event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  });

  // Submit the form data
  document
    .getElementById("addressForm")
    .addEventListener("submit", function (event) {
      event.preventDefault();

      // Get the form input values
      const email = document.getElementById("Email").value;
      const firstName = document.getElementById("firstName").value;
      const lastName = document.getElementById("lastName").value;
      const address = document.getElementById("address").value;
      const phoneNumber = document.getElementById("phoneNumber").value;
      const country = document.getElementById("country").value;
      const state = document.getElementById("state").value;
      const zipCode = document.getElementById("zipCode").value;
      const useForBilling = document.getElementById("same-address").checked;
      console.log(email + firstName + country);

      // Construct the address object
      const addressData = {
        email,
        firstName,
        lastName,
        address,
        country,
        state,
        phoneNumber,
        zipCode,
        useForBilling,
      };
      console.log(addressData);

      // Make a fetch request to the "/add-address" URL
      fetch("/add-address", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(addressData),
      })
        .then((response) => response.json())
        .then((data) => {
          // Handle the response data
          console.log(data);
          // Close the modal after successful submission if desired
          modal.style.display = "none";
        })
        .catch((error) => {
          // Handle any errors
          console.error(error);
        });
    });
</script>

<!-- <script>
  // Open the edit modal and fetch user data
  function openEditModal(addressId) {
    const modal = document.getElementById("editModal");
    const addressIdInput = document.getElementById("addressId");

    // Set the address ID in the hidden input field
    addressIdInput.value = addressId;

    console.log(addressId);

    // Make a fetch request to get the user data for the given address ID
    fetch(`/edit-address/${addressId}`)   
      .then((response) => response.json())
      .then((data) => {
        // Update the form fields with the fetched user data
        document.getElementById("editfirstName").value = data.firstName;
        document.getElementById("editlastName").value = data.lastName;
        document.getElementById("editemail").value = data.email;
        document.getElementById("editphoneNumber").value = data.phoneNumber;
        document.getElementById("editcountry").value = data.country;
        document.getElementById("editstate").value = data.state;
        document.getElementById("editzipCode").value = data.zipCode;
        document.getElementById("editsame-address").value = data.isBillingAddress;

        // Show the modal
        modal.style.display = "block";
      })
      .catch((error) => {
        console.error(error);
      });
  }

  // Submit the edit address form data
  document
    .getElementById("editAddressForm")
    .addEventListener("submit", function (event) {
      event.preventDefault();

      // Get the form input values
      const addressId = document.getElementById("addressId").value;
      const firstName = document.getElementById("firstName").value;
      const lastName = document.getElementById("lastName").value;
      const address = document.getElementById("address").value;
      // ... Get other form values

      // Construct the address object
      const addressData = {
        addressId,
        firstName,
        lastName,
        address,
        // ... Include other form values
      };

      // Make a fetch request to the "/edit-address" URL
      fetch("/edit-address", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(addressData),
      })
        .then((response) => response.json())
        .then((data) => {
          // Handle the response data
          console.log(data);
          // Close the modal after successful submission if desired
          const modal = document.getElementById("editModal");
          modal.style.display = "none";
        })
        .catch((error) => {
          // Handle any errors
          console.error(error);
        });
    });
</script> -->
<script>
  var addressId;
  function openEditModal(id) {

    addressId = id;
    // Get the form input elements
    var emailInput = document.getElementById("editEmail");
    var firstNameInput = document.getElementById("editFirstName");
    var lastNameInput = document.getElementById("editLastName");
    var addressInput = document.getElementById("editAddress");
    var phoneNumberInput = document.getElementById("editPhoneNumber");
    var countryInput = document.getElementById("editCountry");
    var stateInput = document.getElementById("editState");
    var zipCodeInput = document.getElementById("editZipCode");
    var useForBillingCheckbox = document.getElementById("editSameAddress");

    // Make a fetch request to retrieve the address data by ID
    console.log(id + " address id from the open edit model");
    fetch(`/get-address/${id}`)
      .then((response) => {
        return response.json();
      })
      .then((data) => {
        console.log(data);
        // Set the form input values to the address data from the response
        emailInput.value = data.address.email;
        firstNameInput.value = data.address.fname;
        lastNameInput.value = data.address.lname;
        addressInput.value = data.address.address;
        phoneNumberInput.value = data.address.phoneNumber;
        countryInput.value = data.address.country;
        stateInput.value = data.address.state;
        zipCodeInput.value = data.address.zipcode;
        useForBillingCheckbox.checked = data.address.isBillingAddress;
        console.log(emailInput.value);
        console.log(phoneNumberInput.value);
        console.log(stateInput.value);
        console.log(countryInput.value);
        console.log(zipCodeInput.value);
        console.log(addressInput.value);
        console.log(useForBillingCheckbox.value);
        // Open the modal
        let modal = document.getElementById("editModal");

        modal.style.display = "block";
      })
      .catch((error) => {
        console.error(error);
      });
  }

  document.addEventListener("DOMContentLoaded", function () {
    var modal = document.getElementById("editModal");
    var btn = document.getElementById("editAddressButton");
    var closeBtn = document.getElementsByClassName("btn-close-editModal")[0];

    // Close the modal when the close button is clicked
    closeBtn.addEventListener("click", function () {
      modal.style.display = "none";
    });

    // Close the modal when the user clicks outside of it
    window.addEventListener("click", function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    });
  });

  var emailInput = document.getElementById("editEmail");
    var firstNameInput = document.getElementById("editFirstName");
    var lastNameInput = document.getElementById("editLastName");
    var addressInput = document.getElementById("editAddress");
    var phoneNumberInput = document.getElementById("editPhoneNumber");
    var countryInput = document.getElementById("editCountry");
    var stateInput = document.getElementById("editState");
    var zipCodeInput = document.getElementById("editZipCode");
    var useForBillingCheckbox = document.getElementById("editSameAddress");


  const editAddressForm = document.getElementById("editAddressForm");

  var submitBtn = document.getElementById("submitAddressButton");
  submitBtn.addEventListener("click", function () {

    const formData = {
    email: emailInput.value,
    firstName: firstNameInput.value,
    lastName: lastNameInput.value,
    address: addressInput.value,
    phoneNumber: phoneNumberInput.value,
    country: countryInput.value,
    state: stateInput.value,
    zipCode: zipCodeInput.value,
    useForBilling: useForBillingCheckbox.checked,
  };

  var modal = document.getElementById("editModal");
  console.log(addressId + "ðŸš€ðŸš€ðŸš€ðŸš€ðŸš€");
  console.log(formData + "ðŸ˜’ðŸ˜’ðŸ˜’ðŸ˜’ðŸ˜’ðŸ˜’ðŸ˜’");
    console.log(formData+"ðŸ‘ŒðŸ‘ŒðŸ‘ŒðŸ‘Œ");

    // Make a fetch request to submit the data to the backend
    fetch(`/submit-address/${addressId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(formData),
    })
      .then((response) =>{return response.json()})
      .then((data) => {
        // Handle the response data
        console.log(data);
        // Close the modal after successful submission if desired
        window.location.reload()
        modal.style.display = "none";
      })
      .catch((error) => {
        console.error(error);
      });

  });
</script>
