<!-- Main Section-->
<section class="mt-5 container">
  <!-- Page Content Goes Here -->

  <h1 class="mb-6 display-5 fw-bold text-center">Your Cart</h1>

  <div class="row g-4 g-md-8">
    <!-- Cart Items -->
    <div class="col-12 col-lg-6 col-xl-7">
      <div class="table-responsive" id="cartTable">
        <table class="table shopping-summery text-center clean">
          <thead>
            <tr class="main-heading">
              <th scope="col">Image</th>
              <th scope="col">Name</th>
              <th scope="col">Price</th>
              <th scope="col">Quantity</th>
              <th scope="col">Subtotal</th>
              <th scope="col">Remove</th>
            </tr>
          </thead>
          <tbody>
      
            <% products.forEach((item) => { %>      
              <tr data-item-id="<%= item.productId._id %>">
                <td class="image product-thumbnail"><img src="<%= item.productId.image %>" alt="#"></td>
                <td class="product-des product-name">
                  <h5 class="product-name">
                      <%= item.productId.name %>
                    </h5>
                  </p>
                </td>
                <td class="price" data-title="Price"><span>&#8377;<%= item.productId.price %></span></td>
                <td class="text-center" data-title="Stock">
                  <div class="detail-qty border radius  m-auto" data-stockqty="<%= item.productId.stock %>" data-productid="<%= item.productId._id %>">
                    <a class="qty-down"><i class="fi-rs-angle-small-down"></i></a>
                    <span class="qty-val qty-<%= item.product._id %>" id="qty-<%= item.productId._id %>"
                      data-quantity="<%= item.quantity %>">
                      <%= item.quantity %>
      
                    </span>
      
                    <a class="qty-up"><i class="fi-rs-angle-small-up"></i></a>
                  </div>
                </td>
                <td class="text-right" id="subtotal" data-title="Cart" data-price="<%= item.productId.price %>">
                  <span id="subtotalValue">
                    <%= (item.productId.price * item.quantity).toLocaleString('en-IN', { style: 'currency' ,
                      currency: 'INR' }) %>
                  </span>
                </td>
                <td class="action" onclick="removeProduct('<%= item.productId._id %>')" data-title="Remove">
                  <a class="text-muted"><i class="fi-rs-trash"></i></a>
                  <br>
                  <% if (item.productId.stock<item.quantity) { %>
                    <span class="text-danger outOfStock" id="outOfStock-<%= item.product._id %>" class="text-muted">out of stock</span>
                    <% } else { %>
                      <span class="text-danger outOfStock" id="outOfStock-<%= item.product._id %>" class="text-muted"></span>
                    <% } %>
                </td>
              </tr>
              <% }) %>
                <tr>
                  <td colspan="6" class="text-end">
                    <a id="clearCartL" class="text-muted "> <i class="fi-rs-cross-small"></i> Clear Cart</a>
                  </td>
                </tr>
          </tbody>
        </table>
      </div>
      
      <div class="cart-action mb-20 ">
        <a class="btn" href="/shop"><i class="fi-rs-shopping-bag mr-10"></i>Continue shopping</a>
      </div>
      
      <script>
      
        const clearCartLink = document.getElementById('clearCartL');
        clearCartLink.addEventListener('click', () => {
          Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, clear it!',
          }).then(async (result) => {
            if (result.isConfirmed) {
              const url = '/clear-cart';
              const response = await fetch(url, {
                method: 'delete',
                headers: {
                  'Content-Type': 'application/json',
                },
              });
              const result = await response.json();
              if (result.success) {
                window.location.reload();
              } else {
                callAlertify('error', result.message);
              }
            }
          });
        });
      
      
      </script>
    </div>

    <!-- /Cart Items -->
    <div class="col-12 col-lg-6 col-xl-5">
      <div class="bg-dark p-4 p-md-5 text-white">
        <h3 class="fs-3 fw-bold m-0 text-center">Order Summary</h3>
        <div class="py-3 border-bottom-white-opacity">
          <div
            class="d-flex justify-content-between align-items-center mb-2 flex-column flex-sm-row"
          >
            <p class="m-0 fw-bolder fs-6">Subtotal</p>
            <p class="m-0 fs-6 fw-bolder">$<%= subtotal %></p>
          </div>
          <div
            class="d-flex justify-content-between align-items-center flex-column flex-sm-row mt-3 m-sm-0"
          >
            <p class="m-0 fw-bolder fs-6">Shipping</p>
            <span class="text-white opacity-75 small"
              >Will be set at checkout</span
            >
          </div>
        </div>
        <div class="py-3 border-bottom-white-opacity">
          <div
            class="d-flex justify-content-between align-items-center flex-column flex-sm-row"
          >
            <div>
              <p class="m-0 fs-5 fw-bold">Grand Total</p>
              <span class="text-white opacity-75 small"
                >Inc $45.89 sales tax</span
              >
            </div>
            <p class="mt-3 m-sm-0 fs-5 fw-bold">$<%= grandTotal %></p>
          </div>
        </div>

        <!-- Coupon Code-->
        <button
          class="btn btn-link p-0 mt-2 text-white fw-bolder text-decoration-none"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#collapseExample"
          aria-expanded="false"
          aria-controls="collapseExample"
        >
          Have a coupon code?
        </button>
        <div class="collapse" id="collapseExample">
          <div class="card card-body bg-transparent p-0">
            <div class="input-group mb-0 mt-2">
              <input
                type="text"
                class="form-control border-0"
                placeholder="Enter coupon code"
              />
              <button
                class="btn btn-white text-dark px-3 btn-sm border-0 d-flex justify-content-center align-items-center"
              >
                <i class="ri-checkbox-circle-line ri-lg"></i>
              </button>
            </div>
          </div>
        </div>
        <!-- / Coupon Code-->

        <!-- Checkout Button-->
        <a
          href="./checkout.html"
          class="btn btn-white w-100 text-center mt-3"
          role="button"
          ><i class="ri-secure-payment-line align-bottom"></i> Proceed to
          checkout</a
        >
        <a
          href="./checkout.html"
          class="btn btn-orange w-100 text-center mt-3"
          role="button"
          ><i class="ri-paypal-line align-bottom"></i> Checkout with PayPal</a
        >
        <!-- Checkout Button-->
      </div>

      <!-- Payment Icons-->
      <ul class="list-unstyled d-flex justify-content-center mt-3">
        <li class="mx-1 border d-flex align-items-center p-2">
          <i class="pi pi-paypal"></i>
        </li>
        <li class="mx-1 border d-flex align-items-center p-2">
          <i class="pi pi-mastercard"></i>
        </li>
        <li class="mx-1 border d-flex align-items-center p-2">
          <i class="pi pi-american-express"></i>
        </li>
        <li class="mx-1 border d-flex align-items-center p-2">
          <i class="pi pi-visa"></i>
        </li>
      </ul>
      <!-- / Payment Icons-->
    </div>
    <!-- Cart Summary -->

    <!-- /Cart Summary -->
  </div>

  <!-- /Page Content -->
</section>
<!-- / Main Section-->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    function changeQuantity(event, itemId) {
      console.log(event + "" + itemId);
      const input = event.target.parentNode.querySelector(
        'input[type="number"]'
      );
      const action = event.target.dataset.action;
      let quantity = parseInt(input.value);
      console.log(
        "sssssssssssssssssiiiiiiiiiiiiiiiiiiinnnnnnnnnnnnaaaaaaaaaaaaaaaannnnnnnnnnnnnnn"
      );

      if (action === "increment") {
        quantity++;
      } else if (action === "decrement") {
        quantity--;
        if (quantity < 0) quantity = 0;
      }

      input.value = quantity;

      // Make a server request to update the price accordingly
      fetch(`/cart/update-quantity/${itemId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ quantity }),
      })
        .then((response) => response.json())
        .then((data) => {
          // Handle the response data, if needed
          console.log(data);

          // Update the total price in the UI
          const totalPriceCell =
            event.target.parentNode.parentNode.querySelector(".total-price");
          totalPriceCell.textContent = `$${data.totalPrice}`;
        })
        .catch((error) => {
          console.error("Error:", error);
        });
    }

    // Attach event listeners to the buttons
    const decrementButtons = document.querySelectorAll(
      '[data-action="decrement"]'
    );
    const incrementButtons = document.querySelectorAll(
      '[data-action="increment"]'
    );

    decrementButtons.forEach((button) => {
      button.addEventListener("click", function (event) {
        const itemId = this.dataset.itemId;
        changeQuantity(event, itemId);
      });
    });

    incrementButtons.forEach((button) => {
      button.addEventListener("click", function (event) {
        const itemId = this.dataset.itemId;
        changeQuantity(event, itemId);
      });
    });
  });
</script>
